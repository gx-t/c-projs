<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Selections, Double-Clicks and Context Menus</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="GTK+ 2.0 Tree View Tutorial"
HREF="treeview-tutorial.html"><LINK
REL="PREVIOUS"
TITLE="How to Pack Icons into the Tree View"
HREF="sec-treeview-col-pixbufs.html"><LINK
REL="NEXT"
TITLE="Double-Clicks on a Row"
HREF="sec-selections-double-click.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="./treeview-tutorial.css"></HEAD
><BODY
CLASS="chapter"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="95%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>GTK+ 2.0 Tree View Tutorial</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="sec-treeview-col-pixbufs.html"
ACCESSKEY="P"
>&#60;&#60;&#60; Previous</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="sec-selections-double-click.html"
ACCESSKEY="N"
>Next &#62;&#62;&#62;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="95%"></DIV
><DIV
CLASS="chapter"
><H1
><A
NAME="sec-sel-click-menus"
></A
>Chapter 6. Selections, Double-Clicks and Context Menus</H1
><DIV
CLASS="sect1"
><H1
CLASS="sect1"
><A
NAME="sec-selections"
>6.1. Handling Selections</A
></H1
><P
>&#13;One of the most basic features of a list or tree view is that rows can be selected or unselected.
Selections are handled using the <A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>GtkTreeSelection</TT
></A
> object of a tree view. Every
tree view automatically has a <TT
CLASS="literal"
>GtkTreeSelection</TT
> associated with it, and you can
get it using <A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeView.html#gtk-tree-view-get-selection"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_view_get_selection</TT
></A
>. Selections are handled completely on
the tree view side, which means that the model knows nothing about which rows are selected or not.
There is no particular reason why selection handling could not have been implemented with functions
that access the tree view widget directly, but for reasons of API cleanliness and code clarity the
Gtk+ developers decided to create this special <TT
CLASS="literal"
>GtkTreeSelection</TT
> object that then
internally deals with the tree view widget. You will never need to create a tree selection object,
it will be created for you automatically when you create a new tree view. You only need to use said
<TT
CLASS="literal"
>gtk_tree_view_get_selection</TT
> function to get a pointer to the selection object.
</P
><P
>&#13;There are three ways to deal with tree view selections: either you get a list of the currently selected
rows whenever you need it, for example within a context menu function, or you keep track of all select
and unselect actions and keep a list of the currently selected rows around for whenever you need them;
as a last resort, you can also traverse your list or tree and check each single row for whether it is
selected or not (which you need to do if you want all rows that are <I
CLASS="emphasis"
>not</I
> selected
for example).
</P
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="sec-selections-modes"
>6.1.1. Selection Modes</A
></H2
><P
>&#13;You can use <TT
CLASS="literal"
>gtk_tree_selection_set_mode</TT
> to influence the way that selections are
handled. There are four selection modes:
</P
><P
></P
><UL
><LI
><P
>&#13;   <TT
CLASS="literal"
>GTK_SELECTION_NONE</TT
> - no items can be selected
  </P
></LI
><LI
><P
>&#13;   <TT
CLASS="literal"
>GTK_SELECTION_SINGLE</TT
> - no more than one item can be selected
  </P
></LI
><LI
><P
>&#13;   <TT
CLASS="literal"
>GTK_SELECTION_BROWSE</TT
> - exactly one item is always selected
  </P
></LI
><LI
><P
>&#13;   <TT
CLASS="literal"
>GTK_SELECTION_MULTIPLE</TT
> - anything between no item and all items can be selected
  </P
></LI
></UL
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="sec-selections-current"
>6.1.2. Getting the Currently Selected Rows</A
></H2
><P
>&#13;You can access the currently selected rows either by traversing all selected rows using
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-selected-foreach"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_selected_foreach</TT
></A
> or get a
<TT
CLASS="literal"
>GList</TT
> of tree paths of the selected rows using
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-get-selected-rows"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_get_selected_rows</TT
></A
>. Note
that this function is only available in Gtk+-2.2 and newer, which means that you can't
use it or need to reimplement it if you want your application to work with older
installations.
</P
><P
>&#13;If the selection mode you are using is either <TT
CLASS="literal"
>GTK_SELECTION_SINGLE</TT
>
or <TT
CLASS="literal"
>GTK_SELECTION_BROWSE</TT
>, the most convenient way to get the
selected row is the function <TT
CLASS="literal"
>gtk_tree_selection_get_selected</TT
>,
which will return <TT
CLASS="literal"
>TRUE</TT
> and fill in the specified tree iter with
the selected row (if a row is selected), and return <TT
CLASS="literal"
>FALSE</TT
> otherwise.
It is used like this:
</P
><TABLE
BORDER="0"
BGCOLOR="#e3e3c4"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;  ...

  GtkTreeSelection *selection;
  GtkTreeModel     *model;
  GtkTreeIter       iter;

  /* This will only work in single or browse selection mode! */

  selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(view));
  if (gtk_tree_selection_get_selected(selection, &#38;model, &#38;iter))
  {
    gchar *name;

    gtk_tree_model_get (model, &#38;iter, COL_NAME, &#38;name, -1);

    g_print ("selected row is: %s\n", name);

    g_free(name);
  }
  else
  {
    g_print ("no row selected.\n");
  }

  ...
</PRE
></TD
></TR
></TABLE
><P
>&#13;One thing you need to be aware of is that you need to take care when removing rows from
the model in a <TT
CLASS="literal"
>gtk_tree_selection_selected_foreach</TT
> callback, or when
looping through the list that <TT
CLASS="literal"
>gtk_tree_selection_get_selected_rows</TT
> returns
(because it contains paths, and when you remove rows in the middle, then the old paths will
point to either a non-existing row, or to another row than the one selected). You have two ways
around this problem: one way is to use the solution to removing multiple rows that has been
<A
HREF="sec-treemodel-remove-row.html"
>described above</A
>, ie. to get tree row references
for all selected rows and then remove the rows one by one; the other solution is to sort the
list of selected tree paths so that the last rows come first in the list, so that you remove
rows from the end of the list or tree. You cannot remove rows from within a foreach callback in
any case, that is simply not allowed.
</P
><P
>&#13;Here is an example of how to use <TT
CLASS="literal"
>gtk_tree_selection_selected_foreach</TT
>:
</P
><TABLE
BORDER="0"
BGCOLOR="#e3e3c4"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;  ...

  gboolean
  view_selected_foreach_func (GtkTreeModel  *model,
                              GtkTreePath   *path,
                              GtkTreeIter   *iter,
                              gpointer       userdata)
  {
    gchar *name;

    gtk_tree_model_get (model, iter, COL_NAME, &#38;name, -1);

    g_print ("%s is selected\n", name);
  }


  void
  do_something_with_all_selected_rows (GtkWidget *treeview)
  {
    GtkTreeSelection  *selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(treeview));

    gtk_tree_selection_selected_foreach(selection, view_selected_foreach_func, NULL);
  }


  void
  create_view (void)
  {
    GtkWidget         *view;
    GtkTreeSelection  *selection;

    ...

    view = gtk_tree_view_new();

    ...

    selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(view));

    gtk_tree_selection_set_mode(selection, GTK_SELECTION_MULTIPLE);
    ...
  }

  ...
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="sec-selections-function"
>6.1.3. Using Selection Functions</A
></H2
><P
>&#13;You can set up a custom selection function with
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-set-select-function"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_set_select_function</TT
></A
>. This
function will then be called every time a row is going to be selected or
unselected (meaning: it will be called before the selection status of that
row is changed). Selection functions are commonly used for the following things:
</P
><P
></P
><OL
TYPE="1"
><LI
><P
>&#13;    ... to keep track of the currently selected items (then you maintain a list
    of selected items yourself). In this case, note again that your selection
    function is called <I
CLASS="emphasis"
>before</I
> the row's selection status is
    changed. In other words: if the row is <I
CLASS="emphasis"
>going to be</I
>
    selected, then the boolean path_currently_selected variable that is passed
    to the selection function is still <TT
CLASS="literal"
>FALSE</TT
>. Also note that
    the selection function might not always be called when a row is removed,
    so you either have to unselect a row before you remove it to make sure your
    selection function is called and removes the row from your list, or check
    the validity of a row when you process the selection list you keep. You
    should not store tree paths in your self-maintained list of of selected rows,
    because whenever rows are added or removed or the model is resorted the paths
    might point to other rows. Use tree row references or other unique means of
    identifying a row instead.
  </P
></LI
><LI
><P
>&#13;   ... to tell Gtk+ whether it is allowed to select or unselect that specific row
   (you should make sure though that it is otherwise obvious to a user whether a
   row can be selected or not, otherwise the user will be confused if she just
   cannot select or unselect a row). This is done by returning TRUE or FALSE in the
   selection function.
  </P
></LI
><LI
><P
>&#13;   ... to take additional action whenever a row is selected or unselected.
  </P
></LI
></OL
><P
>&#13;Yet another simple example:
</P
><TABLE
BORDER="0"
BGCOLOR="#e3e3c4"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;
  ...

  gboolean
  view_selection_func (GtkTreeSelection *selection,
                       GtkTreeModel     *model,
                       GtkTreePath      *path,
                       gboolean          path_currently_selected,
                       gpointer          userdata)
  {
    GtkTreeIter iter;

    if (gtk_tree_model_get_iter(model, &#38;iter, path))
    {
      gchar *name;

      gtk_tree_model_get(model, &#38;iter, COL_NAME, &#38;name, -1);

      if (!path_currently_selected)
      {
        g_print ("%s is going to be selected.\n", name);
      }
      else
      {
        g_print ("%s is going to be unselected.\n", name);
      }

      g_free(name);
    }

    return TRUE; /* allow selection state to change */
  }


  void
  create_view (void)
  {
    GtkWidget         *view;
    GtkTreeSelection  *selection;

    ...

    view = gtk_tree_view_new();

    ...

    selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(view));

    gtk_tree_selection_set_select_function(selection, view_selection_func, NULL, NULL);
    ...
  }

  ...

</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="sec-selections-check-row"
>6.1.4. Checking Whether a Row is Selected</A
></H2
><P
>&#13;You can check whether a given row is selected or not using the functions

<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-iter-is-selected"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_iter_is_selected</TT
></A
>. or
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-path-is-selected"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_path_is_selected</TT
></A
>.
If you want to know all rows that are <I
CLASS="emphasis"
>not</I
> selected,
for example, you could just traverse the whole list or tree, and use the
above functions to check for each row whether it is selected or not.
</P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="sec-selections-selecting-rows"
>6.1.5. Selecting and Unselecting Rows</A
></H2
><P
>&#13;You can select or unselect rows manually with
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-select-iter"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_select_iter</TT
></A
>,
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-select-path"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_select_path</TT
></A
>,
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-unselect-iter"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_unselect_iter</TT
></A
>,
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-unselect-path"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_unselect_path</TT
></A
>,
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-select-all"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_select_all</TT
></A
>, and
<A
HREF="http://developer.gnome.org/doc/API/2.0/gtk/GtkTreeSelection.html#gtk-tree-selection-unselect-all"
TARGET="_top"
>&#13;<TT
CLASS="literal"
>gtk_tree_selection_unselect_all</TT
></A
>
should you ever need to do that.
</P
></DIV
><DIV
CLASS="sect2"
><H2
CLASS="sect2"
><A
NAME="sec-selections-row-count"
>6.1.6. Getting the Number of Selected Rows</A
></H2
><P
>&#13;Sometimes you want to know the number of rows that are currently selected (for example to set
context menu entries active or inactive before you pop up a context menu). If you are using
selection mode <TT
CLASS="literal"
>GTK_SELECTION_SINGLE</TT
> or <TT
CLASS="literal"
>GTK_SELECTION_BROWSE</TT
>,
this is trivial to check with <TT
CLASS="literal"
>gtk_tree_selection_get_selected</TT
>, which will return
either <TT
CLASS="literal"
>TRUE</TT
> or <TT
CLASS="literal"
>FALSE</TT
> (meaning one selected row or no selected row).
</P
><P
>&#13;If you are using <TT
CLASS="literal"
>GTK_SELECTION_MULTIPLE</TT
> or want a more general approach that works
for all selection modes, <TT
CLASS="literal"
>gtk_tree_selection_count_selected_rows</TT
> will return the
information you are looking for. The only caveat with this function is that it only exists in Gtk+-2.2
and newer, so you will have to reimplement it if you want users with old installations that still use Gtk+-2.0
to be able to use your program as well. Here is a way to reimplement this function:
</P
><TABLE
BORDER="0"
BGCOLOR="#e3e3c4"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;  static void
  count_foreach_helper (GtkTreeModel *model,
                        GtkTreePath  *path,
                        GtkTreeIter  *iter,
                        gpointer      userdata)
  {
    gint *p_count = (gint*) userdata;

    g_assert (p_count != NULL);

    *p_count = *p_count + 1;
  }

  gint
  my_tree_selection_count_selected_rows (GtkTreeSelection *selection)
  {
    gint count = 0;

    gtk_tree_selection_selected_foreach(selection, count_foreach_helper, &#38;count);

    return count;
  }
</PRE
></TD
></TR
></TABLE
></DIV
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="95%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="95%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="sec-treeview-col-pixbufs.html"
ACCESSKEY="P"
>&#60;&#60;&#60; Previous</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="treeview-tutorial.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="sec-selections-double-click.html"
ACCESSKEY="N"
>Next &#62;&#62;&#62;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>How to Pack Icons into the Tree View</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Double-Clicks on a Row</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>